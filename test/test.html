<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

		<title>Swipe Test</title>
		<link rel="stylesheet" href="./qunit.css" type="text/css" media="screen" />

		<script src="http://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
		<script type="text/javascript" charset="utf-8">
			// make sure jQswipe doesn't rely on window.$
			var _$ = $;
			$ = {};
		</script>
		<script src="../jQswipe.js" type="text/javascript"></script>
		<script src="./qunit.js" type="text/javascript"></script>
		<script type="text/javascript">
			jQuery(document).ready(function(){
				var $ = jQuery, swipe = $.jQswipe, touchGenerator;
				

				touchGenerator = function(touches) {
					return function(){
						return touches.shift();
					}
				};
				
				test("Test touchGenerator([ [{pageX: 30, pageY: 30}], [{pageX: 40, pageY: 30}], [{pageX: 50, pageY: 30}] ]) ", 
					function(){
						
						var p1, p2, p3
							touches = [ [{pageX: 30, pageY: 30}], [{pageX: 40, pageY: 30}], [{pageX: 50, pageY: 30}] ],
							getTouches = touchGenerator(touches);
						
						p1 = swipe.Point.fromTouch(getTouches()[0]);
						p2 = swipe.Point.fromTouch(getTouches()[0]);
						p3 = swipe.Point.fromTouch(getTouches()[0]);
						equals(p1.x, 30, "p1.x should be 30");
						equals(p1.y, 30, "p1.y should be 30");
						equals(p2.x, 40, "p2.x should be 40");
						equals(p2.y, 30, "p2.y should be 30");
						equals(p3.x, 50, "p3.x should be 50");
						equals(p3.y, 30, "p3.y should be 30");
					}
				);
				
				
				test("Test Point", function() {
					var p1 = new swipe.Point(1, 2);
						
					equals( p1.x, 1, "p1.x should have been set to 1" );
					equals( p1.y, 2, "p1.y should have been set to 2" );
				});
				
				test("Test Point.fromTouch", function() {
					var p1 = swipe.Point.fromTouch({pageX: 1, pageY: 2});
						
					equals( p1.x, 1, "p1.x should have been set to 1" );
					equals( p1.y, 2, "p1.y should have been set to 2" );
				});
				
				test("Test Point's diff method", function() {
					var p1 = new swipe.Point(1, 2),
						p2 = new swipe.Point(5, 7),
						diff = p2.diff(p1);
						
					equals( diff.x, 4, "Wrong distance on x" );
					equals( diff.y, 5, "Wrong initialisation of y" );
				});
				
				test("Test swipe.start", function(){
					var s = $.event.special.swipe,
						el = $('#main').get(0),
						t1 = [ {pageX: 1, pageY: 2} ];
					
					
					s.start(el, t1);
					equals(s.startPoint(el).x,   1, 'start point x should be set to 1');
					equals(s.startPoint(el).y,   2, 'start point y should be set to 2');
					equals(s.currentPoint(el).x, 1, 'start point x should be set to 1');
					equals(s.currentPoint(el).y, 2, 'start point y should be set to 2');
					equals(s.previousPoint(el),  undefined, 'previousPoint should not be set');
					ok(s.cancelled(el) === false, 'cancelled should be false');
					ok(s.ended(el) === false, 'ended should be false');
					
				});
				
				test("Test swipe.start with multitouch", function(){
					var s = $.event.special.swipe,
						el = $('#main').get(0),
						t1 = [
							{pageX: 1, pageY: 2},
							{pageX: 5, pageY: 7}
						];
					
					s.start(el, t1);
					ok(s.cancelled(el) === true, 'cancelled should be true');
				});
				
				test("Test swipe.update", function(){
					var s = $.event.special.swipe,
						el = $('#main').get(0),
						t1 = [ {pageX: 1, pageY: 2} ],
						t2 = [ {pageX: 5, pageY: 3} ],
						t3 = [ {pageX: 5, pageY: 3} ],
						t4 = [ {pageX: 10, pageY: 12} ];
					
					s.start(el, t1);
					s.update(el, t2);
					s.update(el, t3);
					s.update(el, t4);
					
					equals(s.startPoint(el).x,    1, 'start point x should be set to 1');
					equals(s.startPoint(el).y,    2, 'start point y should be set to 2');
					equals(s.previousPoint(el).x, 5, 'start point x should be set to 5');
					equals(s.previousPoint(el).y, 3, 'start point y should be set to 3');
					equals(s.currentPoint(el).x, 10, 'start point x should be set to 10');
					equals(s.currentPoint(el).y, 12, 'start point y should be set to 12');
					ok(s.cancelled(el) === false, 'cancelled should be false');
					ok(s.ended(el) === false, 'ended should be false');
					
				});
				
				test("Test swipe.update with multitouch", function(){
					var s = $.event.special.swipe,
						el = $('#main').get(0),
						t1 = [ {pageX: 1, pageY: 2} ],
						t2 = [ {pageX: 5, pageY: 3}, {pageX: 25, pageY: 23} ],
						t3 = [ {pageX: 10, pageY: 4} ];
						
					
					s.start(el, t1);
					s.update(el, t2);
					ok(s.cancelled(el) === true, 'cancelled should be true');
					s.update(el, t3);
					ok(s.cancelled(el) === true, 'cancelled should be true');
					
				});
				
				test("Test swipe.update with wrong swipe on y", function(){
					var s = $.event.special.swipe,
						el = $('#main').get(0),
						t1 = [ {pageX: 1, pageY: 2} ],
						t2 = [ {pageX: 5, pageY: 13} ],
						t3 = [ {pageX: 10, pageY: 4} ];
						
					
					s.start(el, t1);
					s.update(el, t2);
					ok(s.cancelled(el) === true, 'cancelled should be true');
					s.update(el, t3);
					ok(s.cancelled(el) === true, 'cancelled should be true');
					
				});
				
				test("Test swipe.update with wrong swipe on x", function(){
					var s = $.event.special.swipe,
						el = $('#main').get(0),
						t1 = [ {pageX: 1, pageY: 2} ],
						t2 = [ {pageX: 0, pageY: 3} ],
						t3 = [ {pageX: 10, pageY: 4} ];
						
					
					s.start(el, t1);
					s.update(el, t2);
					ok(s.cancelled(el) === true, 'cancelled should be true');
					s.update(el, t3);
					ok(s.cancelled(el) === true, 'cancelled should be true');
					
				});
				
				test("Test swipe.end", function(){
					var s = $.event.special.swipe,
						el = $('#main').get(0),
						t1 = [ {pageX: 1, pageY: 2} ],
						t2 = [ {pageX: 31, pageY: 3} ];
						
					
					s.start(el, t1);
					s.update(el, t2);
					s.end(el);
					
					ok(s.cancelled(el) === false, 'cancelled should be false');
					ok(s.ended(el) === true, 'ended should be true');
				});

				test("Test swipe.end wrong y", function(){
					var s = $.event.special.swipe,
						el = $('#main').get(0),
						t1 = [ {pageX: 1, pageY: 2} ],
						t2 = [ {pageX: 31, pageY: 13} ];
						
					
					s.start(el, t1);
					s.update(el, t2);
					s.end(el);
					
					ok(s.cancelled(el) === true, 'cancelled should be false');
					ok(s.ended(el) === true, 'ended should be true');
				});

				test("Test swipe.end wrong x", function(){
					var s = $.event.special.swipe,
						el = $('#main').get(0),
						t1 = [ {pageX: 1, pageY: 2} ],
						t2 = [ {pageX: 30, pageY: 2} ];
						
					
					s.start(el, t1);
					s.update(el, t2);
					s.end(el);
					
					ok(s.cancelled(el) === true, 'cancelled should be false');
					ok(s.ended(el) === true, 'ended should be true');
				});
				
				asyncTest("Test swipe event", 1,  function(){
					var s = $.event.special.swipe,
						ts = [ [ {pageX: 0, pageY: 10} ], [ {pageX: 30, pageY: 0} ], [ {pageX: 30, pageY: 20} ] ],
						el = $('#swipeTarget'),
						_getTouches = s.getTouches;
					
					s.getTouches = touchGenerator(ts)
					el.bind('swipe', function() {
						ok(true, "swipe handler fired");
						start();
					})
					el.trigger('touchstart');
					el.trigger('touchmove');
					el.trigger('touchmove');
					el.trigger('touchend');
					
					s.getTouches = _getTouches;
				});
				
				test("Test too wide swipe fails", function(){
					var s = $.event.special.swipe,
						ts = [ [ {pageX: 0, pageY: 10} ], [ {pageX: 30, pageY: 20} ], [ {pageX: 30, pageY: 21} ] ],
						el = $('#swipeTarget'),
						_getTouches = s.getTouches;
						
					s.getTouches = touchGenerator(ts)
					el.bind('swipe', function() {
						ok(false, "swipe handler should not fired");
					});
					
					el.trigger('touchstart');
					el.trigger('touchmove');
					el.trigger('touchmove');
					el.trigger('touchend');
					
					s.getTouches = _getTouches;
				});
				
				
				test("Test too short swipe fails", function(){
					var s = $.event.special.swipe,
						ts = [ [ {pageX: 0, pageY: 10} ], [ {pageX: 29, pageY: 10} ], [ {pageX: 29, pageY: 10} ] ],
						el = $('#swipeTarget'),
						_getTouches = s.getTouches;
						
					s.getTouches = touchGenerator(ts)
					el.bind('swipe', function() {
						ok(false, "swipe handler should not fired");
					});
					
					el.trigger('touchstart');
					el.trigger('touchmove');
					el.trigger('touchmove');
					el.trigger('touchend');
					
					s.getTouches = _getTouches;
				});

				test("Test rightSwipe event", function(){
					var s = $.event.special.rightSwipe,
						ts = [ [ {pageX: 60, pageY: 10} ], [ {pageX: 40, pageY: 20} ], [ {pageX: 30, pageY: 20} ] ],
						el = $('#swipeTarget'),
						_getTouches = s.getTouches;

					s.getTouches = touchGenerator(ts);
					el.bind('rightSwipe', function() {
						ok(true, "rightSwipe handler fired");
						start();
					});
					
					el.trigger('touchstart');
					el.trigger('touchmove');
					el.trigger('touchmove');
					el.trigger('touchend');

					s.getTouches = _getTouches;
				});

				test("Test rightSwipe and leftSwipe", function(){
					var s1 = $.event.special.rightSwipe,
						s2 = $.event.special.leftSwipe,
						ts = [ [ {pageX: 0, pageY: 10} ], [ {pageX: 10, pageY: 0} ], [ {pageX: 30, pageY: 20} ] ],
						el = $('#swipeTarget'),
						_getTouches1 = s1.getTouches,
						_getTouches2 = s2.getTouches;
						
					expect(1);
					
					s1.getTouches = touchGenerator(ts);
					s2.getTouches = touchGenerator(ts.slice(0, ts.length));
					el.bind('rightSwipe', function() {
						ok(true, "rightSwipe handler called");
						start();
					}).bind('leftSwipe', function(){
						ok(false, "leftSwipe handler should not fire")
					});
					
					el.trigger('touchstart');
					el.trigger('touchmove');
					el.trigger('touchmove');
					el.trigger('touchend');
					
					s1.getTouches = _getTouches1;
					s2.getTouches = _getTouches2;
				});
				
				test("test \"chainability\" of $.fn.swipe", function(){
					var main = $('#main');
					same(main.swipe(function(){}), main);
					main.unbind('swipe');
				});
				
				test("test event monkey patch", function(){
					var t = [[{pageX: 10, pageY:20}]],
						tt = t;
					
					expect(4);
					
					ok($.inArray($.event.props, 'touches'), 'touches added to event');
					ok($.inArray($.event.props, 'targetTouches'), 'targetTouches added to event');
					
					$('#swipeTarget').bind('myEvent', function(e){
						same(e.touches, t, 'event.touches set');
						same(e.targetTouches, tt, 'event.targetTouches set')
					}).trigger({type: 'myEvent', touches: t, targetTouches: tt});
				});

			});
			
				
		</script>
		
	</head>

	<body>
		
		<h1 id="qunit-header">Swipe Test</h1>
		
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		
		<div id="main">
			<div id="swipeTarget"></div>
		</div>

	</body>

</html>

